parameters:
  - name: environment
    type: string
  - name: subscription
    type: string
  - name: component
    type: string

steps:

  - task: TerraformInstaller@0
    displayName: Install > Terraform
    inputs:
      terraformVersion: latest

  - task: AzureCLI@2
    displayName: Apply for ${{ parameters.environment }}
    inputs:
      azureSubscription: rm-narm-${{ parameters.environment }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
            export ARM_CLIENT_SECRET=$servicePrincipalKey
            export ARM_CLIENT_ID=$servicePrincipalId
            export ARM_TENANT_ID=$tenantId
            export ARM_SUBSCRIPTION_ID=${{ parameters.subscription }}

            make env=${{ parameters.environment }} dir=${{ parameters.component }} args=-auto-approve apply
      workingDirectory: $(Build.Repository.Name)
      addSpnToEnvironment: true
      useGlobalConfig: true
