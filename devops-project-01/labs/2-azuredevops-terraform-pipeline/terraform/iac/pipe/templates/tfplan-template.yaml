parameters:
  - name: environment
    type: string
  - name: subscription
    type: string
  - name: component
    type: string

steps:

  - task: TerraformInstaller@0
    displayName: Install > Terraform
    inputs:
      terraformVersion: latest

  - task: AzureCLI@2
    displayName: Plan for ${{ parameters.environment }}
    inputs:
      azureSubscription: rm-narm-${{ parameters.environment }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
            export ARM_CLIENT_SECRET=$servicePrincipalKey
            export ARM_CLIENT_ID=$servicePrincipalId
            export ARM_TENANT_ID=$tenantId
            export ARM_SUBSCRIPTION_ID=${{ parameters.subscription }}

            make env=${{ parameters.environment }} dir=${{ parameters.component }} plan
      workingDirectory: $(Build.Repository.Name)
      addSpnToEnvironment: true
      useGlobalConfig: true

  - bash: |
      # If no changes, no-op and don't continue
      if terraform -chdir=${{ parameters.component }} show plan.out | grep -q " 0 to add, 0 to change, 0 to destroy"; then
        echo "##[section]No changes, terraform apply will not run";

      elif terraform -chdir=${{ parameters.component }} show plan.out | grep -q "No changes."; then
        echo "##[section]No changes, terraform apply will not run";

      # Check if resources destroyed. If no, don't require approval
      elif terraform -chdir=${{ parameters.component }} show plan.out | grep -q "to change, 0 to destroy"; then
        echo "##[section]Approval not required";
        echo "##[section]Automatic terraform apply triggered";
        echo "##vso[task.setvariable variable=approvalRequired;isOutput=true]false"

      # Check if resources destroyed. If yes, require approvals
      else
        echo "##[section]Terraform apply requires manual approval";
        echo "##vso[task.setvariable variable=approvalRequired;isOutput=true]true"
      fi
    name: setvar
    displayName: Vars > Set Variables for next stage
    workingDirectory: $(Build.Repository.Name)
